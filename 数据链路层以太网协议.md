# 数据链路层—以太网协议

[TOC]

### 重新认识四层模型

![image-20231012181823771](C:/Users/86176/AppData/Roaming/Typora/typora-user-images/image-20231012181823771.png)

* TCP/IP分层模型将OSI参考模型分为四层，实际上五层，自顶向下分别是应用层，传输层，网络层，数据链路层和物理层。
* 网络层的IP协议由于具有源IP地址和目的IP地址，可以在网络中唯一的标定两台主机，因此可以说IP具备跨网段、将数据从一台主机发送给另一台主机的能力。然而在同一个网段中只使用IP协议并不能准确的将数据交给目标主机，因此就需要用到下层数据链路层的以太网协议来做到局域网通信，在局域网中顺利的将数据交给目标主机。
* IP协议只关系如何将数据从源主机传送到目标主机中，IP协议本身是不具备可靠性的。因此IP协议需要上层传输层TCP协议完成重传机制等操作来保证IP协议的可靠性。
* TCP协议除了给下层提供重传机制等操作来保持数据的通信可靠性以外，还提供接口供上层应用层使用，例如使用socket编程时，本质上是在使用传输层TCP/UDP协议提供给我们的接口。
* 因此，可以说网络层IP协议提供数据的跨网段传输的能力，传输层TCP协议提供数据传输可靠性，而数据链路层以太网协议是用来提供同网段数据传输的能力，即局域网中主机之间通信—解决了点到点通信问题。

### 以太网

以太网属于局域网中的一种，常见的局域网有3种。

* 以太网是局域网的一种实现方式，但如今以太网占据了绝大多数市场，故某种意义上，以太网就是局域网。
* 令牌环网：令牌环网常用于IBM系统中，在这种网络中有一种专门的帧称为“令牌”，在环路上持续地传输来确定一个节点何时可以发送包。
* 无线LAN/WAN。LAN是指在某一区域内由多台计算机互联成的计算机组。一般是方圆几千米以内。局域网可以实现文件管理、应用软件共享、打印机共享、工作组内的日程安排、电子邮件和传真通信服务等功能。局域网是封闭型的，可以由办公室内的两台计算机组成，也可以由一个公司内的上千台计算机组成。WAN是一种跨越大的、地域性的计算机网络的集合。通常跨越省、市，甚至一个国家。广域网包括大大小小不同的子网，子网可以是局域网，也可以是小型的广域网。

虽然网络中的局域网使用的类型不同，但在网络层，通过IP协议屏蔽掉了底层协议的差异。在网络层及其以上，只关心将数据报向下交付，并不关心底层使用了什么类型的协议。

* 网络层将报文交付给数据链路层，在数据链路层给报文添加上相应的报头。
* 如果数据要跨网段通信，就需要将报文发送给路由器。如果数据要在局域网中通信，就需要将报文发送给目标主机。总之数据到达另一端时，需要去掉报文对应数据链路层的报头，然后再向上交付。
* 路由器发送给下一台主机时，就需要在数据链路层添加上相应的报头。

因此报文在网络中传送，不断地添加数据链路层报头，去掉数据链路层报头，这样就能够在不同的局域网中使用不同类型的局域网协议，最后数据发送到目标主机上。

> 以太网

* "以太网" 不是一种具体的网络, 而是一种技术标准; 既包含了数据链路层的内容, 也包含了一些物理层的 内容. 例如: 规定了网络拓扑结构, 访问控制方式, 传输速率等;
* 如以太网中的网线必须使用双绞线; 传输速率有10M, 100M, 1000M等;

### 局域网特点

* 处在在同一个局域网的主机，可以直接通信。
* 每台主机都必须具备唯一的标识符，即mac地址。mac地址一共6字节48位，该地址是配备在网卡上的，且是全球唯一。

* 在局域网中，一台主机发送的消息，局域网中的所有主机都能够接收到，但是在数据链路层就能够对信息的目的mac地址进行丢弃或者接收向上交付操作。若目的mac地址是本主机地址，那么就将数据包向上交付，若不是，则直接丢弃报文。
* 在数据链路层对数据进行向上交付，这种行为称作抓包。网卡具有混杂模式，即不放弃任何数据帧，无论收到什么报文都接收并且向上交付，不对数据做丢弃操作。即抓包数据的原理。

### 以太网帧格式

以太网帧格式如下：

![](https://non1.oss-cn-guangzhou.aliyuncs.com/write1/202310131831001.png)

* 上层网络层将报文交付到数据链路层，数据链路层需要对该报文进行封装。目的地址是目标主机的mac地址，源地址是源主机的mac地址。这两个地址的长度是48字节，在网卡出厂时就固化好了。
* 类型字段标定帧协议类型。其中帧协议类型有3种值，0800对应，0806对应ARP，0835对应RARP。
* 帧末尾有四位字段，CRC是校验码，数据链路层拿到数据报后，需要对CRC做验证，若验证错误，则报文直接丢弃。

### 碰撞领域和避免碰撞算法

实际上在硬件上传输mac帧是通过光电信号传播，而传播过程中若会出现两个及以上的mac帧在局域网中时会发送数据碰撞，碰撞后的mac帧就容易发送数据丢失，因此mac帧若发生了碰撞，一般情况下是要被目的主机丢弃的。

因此称一个局域网就是一个碰撞域，在碰撞域中，同一时刻出现两个及以上的mac帧在传输，就容易发送数据碰撞。

以太网规定，在同一个时刻只允许一台主机往局域网中发送数据。若主机往局域网中发送的数据发生碰撞，这些主机就需要等待特定的时间间隔。

这样的好处在于：在该间隔期间，没有发生数据碰撞的主机可以继续往局域网中发送数据。等待发送碰撞的数据在局域网中消散。时间间隔结束后，等待的主机可以发送数据。

这样可以有效的错开局域网中主机发送数据的时刻，这样的算法叫做避免碰撞算法。而主机要具备知道自己发送的数据是否发送碰撞的能力，即主机要具备碰撞检测。

实际上，保持局域网消息正常发送就是保证主机都遵守主机的碰撞检测和避免碰撞算法，因此破坏局域网的手段就是不遵守该算法，不断的往局域网中发送垃圾数据，对局域网中的数据进行碰撞破坏。

总结一下：避免碰撞算法就是发送数据碰撞的主机就需要等待一段时间再发送数据，因此在以太网中也存在重传机制，该重传机制是为了保证局域网中一台主机的数据能够发送到目标主机上。

> MAC帧然后将报报头与有效载荷进行分离？

由于以太网MAC帧的帧头和帧尾是固定长度的，因此当数据链路层从底层接收到一份MAC帧时，只需要按照固定长度分离帧头和帧尾，剩下的就是有效载荷了。

> 如何将MAC帧的有效载荷部分交付给上层的相关协议？

在帧头部分有类型字段，根据该字段就能将有效载荷交付给对应的协议。

主机A需要将MAC帧发送给局域网中的主机B。

* 局域网中的所有主机都能够收到该MAC帧，包括主机A。
* 主机A收到自己发送出去的报文后，通过CRC校验和字段检验，如果发送了数据碰撞，就立刻执行避免碰撞算法，后续将MAC重传到局域网中。
* 主机B收到MAC帧后，先是对帧头的目的IP字段做判断，若目的IP本主机IP，则不做报文丢弃行为。接着对CRC校验和字段做检验，若没有发送错误则对MAC帧进行分离操作，按照帧头的类型字段，将有效载荷交付给上层对应协议。若发生错误，则对MAC帧进行丢弃。
* 其他主机收到MAC帧后，对帧头部分的目的IP字段做判断，得知目的IP不是本主机IP，执行报文丢弃行为。

### 认识MAC地址

* MAC地址用来识别数据链路层中相连的节点。
* 长度为48位, 及6个字节. 一般用16进制数字加上冒号的形式来表示(例如: 08:00:27:03:fb:19)。
* 在网卡出厂时就确定了, 不能修改. mac地址通常是唯一的(虚拟机中的mac地址不是真实的mac地址, 可 能会冲突; 也有些网卡支持用户配置mac地址)。
* 通过ifconfig查看ether后接的就是mac地址

![image-20231013192529861](https://non1.oss-cn-guangzhou.aliyuncs.com/write1/202310131925611.png)

### 令牌环网

* 令牌环网是IBM公司于70年代发展的，21世纪以后这种网络比较少见。在老式的令牌环网中，数据传输速度为4Mbps或16Mbps，新型的快速令牌环网速度可达100Mbps。
* 令牌环网的传输方法在物理上采用了星形拓扑结构，但逻辑上仍是环形拓扑结构。

![image-20231013194910539](https://non1.oss-cn-guangzhou.aliyuncs.com/write1/202310131949395.png)

* 其通信传输介质可以是无屏蔽双绞线、屏蔽双绞线和光纤等。

> 令牌的工作原理

* 在这种令牌环网中，有一种专门的帧称为“令牌”，在环路上持续地传输来确定令牌环网上的主机（节点）何时可以发送数据包。
* 令牌环网的媒体接入控制机制采用的是分布式控制模式的循环方法。即在令牌环网中有一个令牌(Token)沿着环形总线在入网节点计算机间依次传递。令牌实际上是一个特殊格式的帧，本身并不包含信息，仅控制信道的使用，**确保在同一时刻只有一个节点能够独占信道**。
* 当环上节点都空闲时，令牌绕环行进。节点计算机只有取得令牌后才能发送数据帧，因此不会发生碰撞。由于令牌在网环上是按顺序依次传递的，因此对所有入网计算机而言，访问权是公平的。
* 令牌在工作中有“闲”和“忙”两种状态。“闲”表示令牌没有被占用，即网中没有计算机在传送信息；“忙”表示令牌已被占用，即网中有信息正在传送。
* 希望传送数据的计算机必须首先检测到“闲”令牌，将它置为“忙”的状态，然后在该令牌后面传送数据。当所传数据被目的节点计算机接收后，数据被从网中除去，令牌被重新置为“闲”。

当然令牌环网也有缺点。在令牌环网中需要维护令牌，一旦失去令牌就无法工作，因此需要选择专门的节点监视和管理令牌。

总结一下：

1. 以太网采用的是主机的碰撞检测和避免碰撞算法，如果发生了数据碰撞，那么发送该碰撞的主机就需要等待一段时间再发送，等待期间，没有发生数据碰撞的主机可以往局域网中发送数据，一定程度上避免了数据碰撞。而光电信号的传播数据极快，这种做法基本上能够避免局域网的数据碰撞问题。
2. 令牌环网是在通过令牌在网内流通，环网内的主机去获取令牌，获取到令牌的主机才能够往环网中发送数据，即保证了任一时刻只有一台主机往环网内发送数据。这里可以将环网近似看作临时资源，环网上的主机发送数据的行为看作成访问临时资源的临界区，而令牌就是锁，拿到锁的进程才能进入临界区访问临界资源。虽然以太网和令牌环网处理数据碰撞的方式不同，但殊途同归。

### 交换机

在网络层中使用的中间设备是路由器，在数据链路层中使用的中间设备是交换机。

![image-20231013205244767](https://non1.oss-cn-guangzhou.aliyuncs.com/write1/202310132052134.png)

交换机的作用：

1. **识别局部性的碰撞，对碰撞过的数据不做转发**。交换机 会放置在局域网中，对局域网进行局部划分。例如左局部的主机需要向右局部的主机发送数据时，需要通过交换机进行转发。若转发的数据在左局部网已经被碰撞了，交换机不做转发，减少右局域网的数据碰撞概率，保护了右局部网。例如主机A要向主机E发生数据，数据在左局部网中已经发生碰撞了，交换机接收到数据后，不会将数据转发到右局部网，而是直接丢弃。
2.  **不对局域网中的局部域的数据进行转发**。例如主机A向C主机发送数据，理论上局域网中的所有数据都会接收到该数据如何在数据链路层中做相应处理。而主机A和主机C存在局域网中的同一个局部域，那么交换机不会将该数据转发到另一个局部域中，减少了另一个局部域的数据碰撞的几率。

因此这也看出局域网的范围不能太大，局域网太大，其包含的主机数量越多，局域网就越难以管理，数据碰撞的几率就越大。

### 认识MTU

以太网帧中的数据长度规定最小46字节,最大1500字节,ARP数据包的长度不够46字节,要在后面补填充位。

最大值1500称为以太网的最大传输单元，即MTU（最大传输单元（Maximum Transmission Unit），不同的网络类型有不同的MTU，不同的数据链路层规定标准的MTU也是不同的;

如果一个数据包从以太网路由到拨号链路上,数据包长度大于拨号链路的MTU了,则需要对数据包进行分片(fragmentation);

### MTU对IP协议的影响















1. 在同一个局域网的主机，可以直接通信。
2. 每台主机都必须具备唯一的标识符，即mac地址。mac地址一共6字节48位，该地址是配备在网卡上的，且是全球唯一。
3. mac报头具有目的mac地址，源mac地址，和mac帧类型（0800指IP数据报类型，0806指ARP数据包类型，8035指RARP类型，然后是46字节~1500字节的有效载荷，最后是四字节的校验码CRC。
4. 通过ifconfig查看ether后接的就是mac地址
5. 在局域网中，一台主机发送的消息，局域网中的所有主机都能够接收到，但是在数据链路层就能够对目的mac地址进行丢弃或者接收向上交付操作。
6. 混杂模式：网卡具有混杂模式，不放弃任何数据帧，无论收到什么报文都接收并且向上交付，不对数据做丢弃操作。即抓包数据的原理。
7. 实际上在硬件上传输mac帧是通过光电信号传播，而传播过程中若会出现两个及以上的mac帧在局域网中时会发送数据碰撞，碰撞后的mac帧就容易发送数据丢失，因此mac帧若发生了碰撞，一般情况下是要被目的主机丢弃的。即一个局域网就是一个碰撞域，如果同一时刻局域网中存在多个消息在传播，就会发生数据碰撞，产生无效数据。因此在同一个时刻只允许一台数据在发生数据。而避免数据碰撞的手段是主机的碰撞检测和避免碰撞算法。
8. 局域网目前有两种，一是令牌环网，一个局域网分配有一个令牌，具备令牌的主机才能往局域网中发送数据，发送完后会将令牌转让给下一台主机。可以认为局域网是一种灵界资源，往局域网中发送数据的动作是临界区，而令牌就是一个保护临界区的互斥锁，具备锁的主机才能进入临界区访问临界资源。
9. 二是以太网，以太网采用的是主机的碰撞检测和避免碰撞算法，如果发生了数据碰撞，那么发送该碰撞的主机就需要等待一段时间再发送，等待期间，没有发生数据碰撞的主机可以往局域网中发送数据，一定程度上避免了数据碰撞。而光电信号的传播数据极快，这种做法基本上能够避免局域网的数据碰撞问题。该做法与令牌环网的做法殊途同归。
10. 保持局域网消息正常发送就是保证主机都遵守主机的碰撞检测和避免碰撞算法，因此破坏局域网的手段就是不遵守该算法，不断的往局域网中发送垃圾数据，对局域网中的数据进行碰撞破坏。、
11. 在网络层中使用的中间设备是路由器，在数据链路层中使用的中间设备是交换机。交换机的作用：其一：**识别局部性的碰撞，对碰撞过的数据不做转发**。交换机会放置在局域网中，对局域网进行局部划分。例如左局部的主机需要向右局部的主机发送数据时，需要通过交换机进行转发。若转发的数据在左局部网已经被碰撞了，交换机不做转发，减少右局域网的数据碰撞概率，保护了右局部网。其二：**不对局域网中的局部域的数据进行转发**。例如m1主机向m3主机发送数据，理论上局域网中的所有数据都会接收到该数据如何在数据链路层中做相应处理。而 m1主机和m3主机存在局域网中的同一个局部域，那么交换机不会将该数据转发到另一个局部域中，减少了另一个局部域的数据碰撞的几率。
12. 局域网本身名字也赋予了该网域大小意义。局域网太大，其包含的主机数量越多，那么数据碰撞的几率就越大。
13. MTU可以通过ifconfig查询。
14. MTU大小46~1500（单位是字节）。而主机会规定MTU的大小，实际上路由器也会规定MTU的大小，因此会出现主机分片好的IP数据包在路径上经过路由器时，会被路由器再次进行分片，使得IP报文更小。因此三位标志位中存在一位禁止分片标志位。如果这次网络通信要求数据吞吐量大的话，就设置该禁止分片标志位。若路径上的路由器想要对该IP报文分片时，由于报文禁止分片，因此该报文会被路由器丢弃。然后触发重传机制，源IP重新选择发送路径，重复多次找到一条吞吐量最大的通信路径。而本身IP数据包就比较小的就可以选择路由器MTU较小的路径，即吞吐量较小的路径，吞吐量越小，除了发送数据碰撞的几率越小以外，通信速度也越快，因此请求和相应的速度就越快。
15. 由于数据链路规定了MTU最大为1500字节，因此网络层IP协议就需要规定有效载荷最大为1480，因此网络层就需要规定报文的有效载荷最大为1460.而1460为S=MSS(MAX SEGMENT SIZE—最大报文长度)即为用户所能一次性发送的最大数据大小。

# ARP协议

源主机只知道目的IP，而根据目的IP能够找到目标主机所处的局域网，但是不知道目标主机的MAC地址。因此需要在目的主机的路由器中，根据目的IP得到目标主机的MAC地址，进而能够将报文发送到目标主机。根据目的IP获得目标主机的技术叫做ARP协议。