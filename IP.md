# IP

### 网络层简介

网络层是OSI参考模型中的第三层，介于传输层和数据链路层之间，其主要作用是实现两个不同网络系统之间的数据透明传送，具体包括路由选择，拥塞控制和网际互连等。网络层负责在不同的网络之间(基于数据包的IP地址)尽力转发数据包，不负责丢包重传和接收顺序。

![image-20231007220645398](https://non1.oss-cn-guangzhou.aliyuncs.com/write1/202310072206710.png)

而IP协议就是网络层中的一个重要协议。

### IP协议简介

IP指网际互连协议，Internet Protocol的缩写，是TCP/IP体系中的网络层协议。设计IP的目的是提高网络的可扩展性：一是解决互联网问题，实现大规模、异构网络的互联互通；二是分割顶层网络应用和底层网络技术之间的耦合关系，以利于两者的独立发展。根据端到端的设计原则，IP只为主机提供一种**无连接、不可靠的**、尽力而为的数据包传输服务。

IP协议主要包含三方面内容：IP编址方案、分组封装格式以及分组转发规则。

### IP协议文格式

![image-20231007221202627](https://non1.oss-cn-guangzhou.aliyuncs.com/write1/202310072212729.png)

IP协议报文由报头和数据组成。由于IP位于网络层，而网络层是OSI参考模型的第三层，因此数据自顶向下做封装时，IP报文的数据部分必然包含上两层的报头和有效载荷。先对IP报头进行介绍。

### IP协议报头

> * 四位版本号：指定IP数据报中使用的IP协议版本，占4位，IPv4对应值为4（0100）。
> * 4位首部长度：这与TCP的四位首部长度含义相同。四位范围为[0,15]（单位是字节）。四位首部长度=四位范围*4字节，因此四位首部长度范围为[0,60]。因为标准报头不包含选项内容，即标准报头大小为20字节，因此四位首部长度范围为[20,60]。

### 公网环境

路由器在不同的网段中具有不同的IP。IP地址是网段标识.1

DHCP是存在于路由器中的网络IP添加释放的一套自动化服务。动态分配IP地址

路由器有两个口子：lan口IP面对内网。wan口IP面对公网

通常我们使用服务，我们使用的是内网IP即源IP是内网IP，而目的IP是公网IP。我们向公网IP发送请求。而此时服务器面对的是一个内网IP，内网IP是可以重复的，因此服务器就不知道将响应发给谁。

因此实际上我们发送的报文会通过路由器。路由器会将报文的源IP（内网IP）转换为wan口IP，然后继续向服务器发送，经过多个路由器的wan口IP转换后，服务器拿到的就是公网IP了。其中内网转换其他类型的IP的技术叫做NAP技术。

