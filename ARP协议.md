# ARP协议

![](https://non1.oss-cn-guangzhou.aliyuncs.com/write1/202310171719160.gif)

[TOC]

地址解析协议，即ARP（Address Resolution Protocol），是根据IP地址获取物理地址的一个TCP/IP协议。

### ARP协议的作用

* ARP协议建立了主机IP和MAC地址的映射关系。

在网络通信中，知道目标主机的IP地址，可以将数据报文发送到目标主机所在的局域网，实际上是将数据报文发送到管理该局域网的路由器。然后由路由器将数据报文转发到目标主机上。在局域网中通信需要先知道目标主机的物理地址，而此时数据报文内只包含目标主机的IP地址，并不包含该主机的mac地址。因此在局域网中正式通信之前，需要根据目标主机的IP地址，获取到mac地址，然后才能将数据报文封装成mac帧，转发到目标主机。**ARP协议就是通过IP地址获取mac地址这样的一个协议**。

### ARP协议的定位

ARP协议即知道IP地址，也能通过IP地址获取到mac地址，因此ARP协议是处于网络层和数据链路层之间的协议。准确来说是处于以太网协议的上层。

在TCP/IP四层模型中，网络协议栈自顶向下分为四层，分别是应用层、传输层、网络层、数据链路层。

其中应用层最常见协议的是HTTP、HTTPS和DNS，传输层最常见协议的是TCP、UDP，网络层最常见协议的是IP，数据链路层最常见协议的是MAC协议。

![image-20231017151219887](https://non1.oss-cn-guangzhou.aliyuncs.com/write1/202310171512981.png)

而ARP、RARP协议和MAC帧协议虽然同属于数据链路层，但ARP协议和RARP协议都位于MAC帧协议的上层。

![image-20231017152525759](https://non1.oss-cn-guangzhou.aliyuncs.com/write1/202310171525005.png)

* 因此mac帧协议的上层协议不一定是IP协议，有可能是ARP/RARP。也就是说mac帧解包后向上交付时不只会交付给IP协议，也可能会交付给ARP、RARP协议。
* 与之类似的还有ICMP协议/IMP协议都与IP协议同属于网络层，但ICMP协议/IMP协议位于IP协议的上层。

### ARP数据报的格式

![image-20231017161711713](https://non1.oss-cn-guangzhou.aliyuncs.com/write1/202310171617747.png)

* 注意到mac帧首部的源MAC地址、目的MAC地址在以太网首部和ARP请求中各出现一次,对于链路层为以太网的情况是多余的,但如果链路层是其它类型的网络则有可能是必要的。帧类型是指除去mac帧首部后，根据帧类型将有效载荷向上交付给哪个协议。例如帧类型是0800，有效载荷就向上交付给IP协议，帧类型是0806，向上交付给ARP协议，帧类型是8035，向上交付给RARP协议。
* 硬件类型指链路层网络类型,1为以太网。
* 协议类型指要转换的地址类型,0x0800为IP地址。即根据该协议类型转换为mac地址。
* 硬件地址长度对于以太网地址为6字节。
* 协议地址长度对于IP地址为4字节。
* op字段为1表示ARP请求,op字段为2表示ARP应答。
* 在主机不知道目标主机的mac地址的场景下，会将目的以太网地址的字段填充为全F，表示该字段未知。

### ARP协议的工作流程

这里以主机1向主机5发送数据报文为例

![image-20231017162045901](https://non1.oss-cn-guangzhou.aliyuncs.com/write1/202310171620287.png)

* 数据报文在主机1中，从应用层自顶向下封装交付过程中，由于不知道目标主机的mac地址，操作系统会调用相关接口，不由IP层将报文直接交给mac层，而是交给ARP层。ARP对数据报文进行封装，在OP处填充字段为1表示该ARP报文为ARP请求，由于不知道目标主机的mac地址，因此目标以太网地址填充为全F，接着将报文向下交付给mac层。mac层对数据报文进行封装后，以局域网内广播的方式发出。

![image-20231017163243892](https://non1.oss-cn-guangzhou.aliyuncs.com/write1/202310171632776.png)

* 由于该mac帧是在局域网中以广播的方式发出，因此局域网中的所有主机都能够收到该报文。收到报文后依次解包并向上交付，报文达到ARP层时，先查看OP，得知该报文是ARP请求，再去查看目标主机IP地址，若不是本主机IP就丢弃报文。**注意该ARP请求是在ARP层丢弃的。**
* ARP请求中的目标主机IP是本主机IP，就构建ARP响应。首先对ARP报文的OP字段设置为2，表示该ARP报文类型是ARP响应。然后将本主机的MAC地址填充到源主机MAC地址字段上。依次填充字段后向下交付给MAC层，由mac帧协议封装成mac帧。然后以广播的方式在局域网中发出。

![image-20231017164040042](https://non1.oss-cn-guangzhou.aliyuncs.com/write1/202310171640882.png)

* 由于该mac帧是在局域网中以广播的方式发出，因此局域网中的所有主机都能够收到该报文。收到报文后依次解包并向上交付，报文达到ARP层时，先查看OP，得知该报文是ARP响应，再去查看目标主机IP地址，若不是本主机IP就丢弃报文。注意**该ARP响应是在ARP层丢弃的。**
* ARP响应中的目标主机IP是本主机IP，就对该ARP响应做处理。这样主机1就拿到主机5的mac地址，主机1就能够与主机5构建网络通信了。

总结一下：

1. 主机的ARP层能够到达的报文有两种，分别是ARP请求和ARP响应，不同类型的ARP报文所应对的处理方式不同。然后再去查看ARP报文的目的主机IP，根据该IP地址抉择是将该报文丢弃还是处理。
2. 由于是在局域网中以广播的形式进行ARP请求和响应，每个主机都能够接收到该ARP报文，因此很容易能够在局域网中以ARP请求洪水或ARP响应洪水的方式充当ARP通信中间人，破坏局域网中的通信。因此局域网中正常的ARP请求/响应是建立在局域网中的主机都遵守规则的基础上。

### ARP缓存表

实际不是每次要获取对方的MAC地址时都需要发起ARP请求，每次发起ARP请求后都会建立对应主机IP地址和MAC地址的映射关系，每台主机都维护了一个ARP缓存表，我们可以用`arp -a`命令进行查看。

![image-20231017165939471](https://non1.oss-cn-guangzhou.aliyuncs.com/write1/202310171659340.png)

每次发起ARP请求时，会先去缓存表中查看是否已经存在需要的IP地址和MAC地址的映射关系，若存在就在缓存表中提取即可，若不存在就构建请求以广播的方式在局域网中发出，获取目标主机的MAC地址，收到ARP响应后，再将对应的映射添加到ARP缓存表中，这种方式得到的映射表项就是**动态映射**。

通过手动方式添加的表项就是**静态映射**。这种方式添加的表项比较死板，因为对应的映射关系不一定固定不变。但是，静态映射更加安全，不会被攻击者通过ARP请求响应报文添加错误的映射关系。

需要注意的是，缓存表中的表项有过期时间，这个时间一般为20分钟，如果20分钟内没有再次使用某个表项，那么该表项就会失效，下次使用时就需要重新发起ARP请求来获得目的主机的硬件地址。

> MAC帧的报头当中已经涵盖了源和目的MAC地址，为什么ARP的报头当中还要有这两个字段？

* 需要注意的是，MAC帧和ARP虽然都在数据链路层，但毕竟是上下层的关系，因此它们不会互相关心彼此报头当中的数据。
* 如果底层网络采用的不是以太网，而是其他类型的网络，此时ARP层的MAC地址就是必要的字段。

> 在局域网中，ARP请求和响应是广播的方式发送，那局域网通信时，数据不也能通过广播的形式发出吗？

* 在局域网通信时，大多数情况是只知道目标主机的IP地址，不知道目标主机的MAC地址，此时就需要构建ARP请求并以广播的形式发出，**广播的形式在于让存在局域网的目标主机尽可能得收到ARP请求，而丢弃ARP请求的根据是目标主机IP地址**。

* 局域网中数据通信，而在不知道目标主机IP地址情况下，以广播的形式将数据发出，数据会从数据链路层向上交付到网络层，而在网络层中判断，网络层是由操作系统管理的，这会对网络资源和操作系统资源造成一定的资源浪费。而报文丢弃应该在网络层之下丢弃，而不是向上交付到网络层后再判断。

**注意：** ARP属于局域网通信的协议标准，因此一台主机不能跨网络向另一台主机发起ARP请求。

### RARP协议

RARP（Reverse Address Resolution Protocol，反向地址转换协议），是根据MAC地址获取IP地址的一个TCP/IP协议。

也就是说，某些情况下我们可能只知道对应主机的MAC地址，此时要得知该主机的IP地址就可以使用RARP协议。

理论上来说，RARP协议一定比ARP协议简单，因为既然我们已经知道一台主机的MAC地址了，那么我们就已经可以直接向给主机发送消息了，因此我们可以直接发消息询问对方的IP地址就行了。